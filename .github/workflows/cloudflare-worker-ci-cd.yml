name: Cloudflare Worker + D1 CI/CD

on:
  pull_request:
    paths:
      - "worker/**"
      - ".github/workflows/cloudflare-worker-ci-cd.yml"
  push:
    branches:
      - main
    paths:
      - "worker/**"
      - ".github/workflows/cloudflare-worker-ci-cd.yml"
  workflow_dispatch:
    inputs:
      apply_d1_migrations:
        description: "Apply D1 migrations during deployment"
        required: false
        type: boolean
        default: true

permissions:
  contents: read

jobs:
  worker-ci:
    runs-on: ubuntu-latest
    if: ${{ hashFiles('worker/package.json') != '' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "worker/package-lock.json"

      - name: Install dependencies
        working-directory: worker
        run: npm ci

      - name: Lint
        working-directory: worker
        run: npm run lint --if-present

      - name: Test
        working-directory: worker
        run: npm test --if-present

      - name: Build
        working-directory: worker
        run: npm run build --if-present

  worker-cd:
    runs-on: ubuntu-latest
    needs: worker-ci
    if: ${{ (github.event_name == 'workflow_dispatch' || github.ref == 'refs/heads/main') && hashFiles('worker/wrangler.toml') != '' }}
    environment: production
    env:
      SHOULD_APPLY_MIGRATIONS: ${{ github.event.inputs.apply_d1_migrations || 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "worker/package-lock.json"

      - name: Install dependencies
        working-directory: worker
        run: npm ci

      - name: Deploy Worker
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: "worker"
          command: deploy --config wrangler.toml

      - name: Apply D1 migrations
        if: ${{ env.SHOULD_APPLY_MIGRATIONS == 'true' && vars.CF_D1_DATABASE_NAME != '' }}
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: "worker"
          command: d1 migrations apply ${{ vars.CF_D1_DATABASE_NAME }} --remote --config wrangler.toml
